// Default templates configuration for both categories
const defaultTemplates = {
  tools: {
    2: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercent: 36,
          yPercent: 53,
          rotation: 5,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercent: 66,
          yPercent: 44.5,
          rotation: -16,
        },
        {
          id: "text3",
          content: "Kelvin",
          xPercent: 66,
          yPercent: 57,
          rotation: 6,
        },
      ],
    },
    1: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercent: 36.5,
          yPercent: 55,
          rotation: 5,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercent: 67,
          yPercent: 52.5,
          rotation: -5,
        },
      ],
    },
    3: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercent: 36,
          yPercent: 54,
          rotation: 5,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercent: 64,
          yPercent: 38.5,
          rotation: -24,
        },
        {
          id: "text3",
          content: "Kelvin",
          xPercent: 67.7,
          yPercent: 51.5,
          rotation: -5,
        },
        {
          id: "text4",
          content: "Emma",
          xPercent: 62.5,
          yPercent: 66,
          rotation: 23,
        },
      ],
    },
    4: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercent: 36,
          yPercent: 52,
          rotation: 5,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercent: 59,
          yPercent: 31,
          rotation: -50,
        },
        {
          id: "text3",
          content: "Kelvin",
          xPercent: 68.5,
          yPercent: 43,
          rotation: -20,
        },
        {
          id: "text4",
          content: "Emma",
          xPercent: 68,
          yPercent: 55,
          rotation: 5,
        },
        {
          id: "text5",
          content: "Jake",
          xPercent: 59,
          yPercent: 67,
          rotation: 45,
        },
      ],
    },
    5: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercent: 36,
          yPercent: 52,
          rotation: 5,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercent: 48,
          yPercent: 29,
          rotation: -80,
        },
        {
          id: "text3",
          content: "Kelvin",
          xPercent: 63,
          yPercent: 38,
          rotation: -35,
        },
        {
          id: "text4",
          content: "Emma",
          xPercent: 66,
          yPercent: 50,
          rotation: -10,
        },
        {
          id: "text5",
          content: "Jake",
          xPercent: 62,
          yPercent: 61,
          rotation: 25,
        },
        {
          id: "text6",
          content: "Lily",
          xPercent: 49.5,
          yPercent: 69,
          rotation: 60,
        },
      ],
    },
    6: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercent: 37,
          yPercent: 52,
          rotation: 5,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercent: 44,
          yPercent: 30,
          rotation: -90,
        },
        {
          id: "text3",
          content: "Kelvin",
          xPercent: 57,
          yPercent: 31,
          rotation: -70,
        },
        {
          id: "text4",
          content: "Emma",
          xPercent: 67,
          yPercent: 42,
          rotation: -30,
        },
        {
          id: "text5",
          content: "Jake",
          xPercent: 65,
          yPercent: 56,
          rotation: 25,
        },
        {
          id: "text6",
          content: "Lily",
          xPercent: 56,
          yPercent: 66,
          rotation: 50,
        },
        {
          id: "text7",
          content: "Noah",
          xPercent: 44,
          yPercent: 70,
          rotation: 86,
        },
      ],
    },
  },
  soccer: {
    2: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercent: 36,
          yPercent: 53,
          rotation: 5,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercent: 66,
          yPercent: 44.5,
          rotation: -16,
        },
        {
          id: "text3",
          content: "Kelvin",
          xPercent: 66,
          yPercent: 57,
          rotation: 6,
        },
      ],
    },
    1: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercent: 36.5,
          yPercent: 55,
          rotation: 5,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercent: 67,
          yPercent: 52.5,
          rotation: -5,
        },
      ],
    },
    3: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercent: 36,
          yPercent: 54,
          rotation: 5,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercent: 64,
          yPercent: 38.5,
          rotation: -24,
        },
        {
          id: "text3",
          content: "Kelvin",
          xPercent: 67.7,
          yPercent: 51.5,
          rotation: -5,
        },
        {
          id: "text4",
          content: "Emma",
          xPercent: 62.5,
          yPercent: 66,
          rotation: 23,
        },
      ],
    },
    4: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercent: 36,
          yPercent: 52,
          rotation: 5,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercent: 59,
          yPercent: 31,
          rotation: -50,
        },
        {
          id: "text3",
          content: "Kelvin",
          xPercent: 68.5,
          yPercent: 43,
          rotation: -20,
        },
        {
          id: "text4",
          content: "Emma",
          xPercent: 68,
          yPercent: 55,
          rotation: 5,
        },
        {
          id: "text5",
          content: "Jake",
          xPercent: 59,
          yPercent: 67,
          rotation: 45,
        },
      ],
    },
    5: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercent: 36,
          yPercent: 52,
          rotation: 5,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercent: 48,
          yPercent: 29,
          rotation: -80,
        },
        {
          id: "text3",
          content: "Kelvin",
          xPercent: 63,
          yPercent: 38,
          rotation: -35,
        },
        {
          id: "text4",
          content: "Emma",
          xPercent: 66,
          yPercent: 50,
          rotation: -10,
        },
        {
          id: "text5",
          content: "Jake",
          xPercent: 62,
          yPercent: 61,
          rotation: 25,
        },
        {
          id: "text6",
          content: "Lily",
          xPercent: 49.5,
          yPercent: 69,
          rotation: 60,
        },
      ],
    },
    6: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercent: 37,
          yPercent: 52,
          rotation: 5,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercent: 44,
          yPercent: 30,
          rotation: -90,
        },
        {
          id: "text3",
          content: "Kelvin",
          xPercent: 57,
          yPercent: 31,
          rotation: -70,
        },
        {
          id: "text4",
          content: "Emma",
          xPercent: 67,
          yPercent: 42,
          rotation: -30,
        },
        {
          id: "text5",
          content: "Jake",
          xPercent: 65,
          yPercent: 56,
          rotation: 25,
        },
        {
          id: "text6",
          content: "Lily",
          xPercent: 56,
          yPercent: 66,
          rotation: 50,
        },
        {
          id: "text7",
          content: "Noah",
          xPercent: 44,
          yPercent: 70,
          rotation: 86,
        },
      ],
    },
  },
};

// Current state
let currentCategory = "soccer";
let currentKids = 1;
let currentColor = "Black";
let currentTemplates = JSON.parse(
  JSON.stringify(defaultTemplates[currentCategory])
);
let textOverlays = {};
let selectedOverlay = null;
let isDragging = false;
let dragStartPos = { x: 0, y: 0 };

// DOM elements
const baseImage = document.getElementById("baseImage");
const imageContainer = document.getElementById("imageContainer");
const textControlsContainer = document.getElementById("text-controls");
const exportBtn = document.getElementById("exportBtn");
const importBtn = document.getElementById("importBtn");
const importFile = document.getElementById("importFile");

// Initialize the application
function init() {
  setupEventListeners();
  updateImageSource();
  updateTemplate();
}

function setupEventListeners() {
  // Category selection
  document.querySelectorAll(".category-variant").forEach((variant) => {
    variant.addEventListener("click", handleCategoryChange);
  });

  // Kids selection
  document.querySelectorAll('input[name="kids"]').forEach((radio) => {
    radio.addEventListener("change", handleKidsChange);
  });

  // Color variants
  document.querySelectorAll(".color-variant").forEach((variant) => {
    variant.addEventListener("click", handleColorChange);
  });

  // Export/Import
  exportBtn.addEventListener("click", exportTemplate);
  importBtn.addEventListener("click", () => importFile.click());
  importFile.addEventListener("change", importTemplate);

  // Image container mouse events for dragging
  imageContainer.addEventListener("mousedown", handleMouseDown);
  document.addEventListener("mousemove", handleMouseMove);
  document.addEventListener("mouseup", handleMouseUp);
}

function handleCategoryChange(e) {
  // Update selected style
  document.querySelectorAll(".category-variant").forEach((variant) => {
    variant.classList.remove("selected");
  });
  e.target.classList.add("selected");

  currentCategory = e.target.dataset.category;
  currentTemplates = JSON.parse(
    JSON.stringify(defaultTemplates[currentCategory])
  );
  updateImageSource();
  updateTemplate();
}

function handleKidsChange(e) {
  // Update selected style
  document.querySelectorAll(".kids-options .option-item").forEach((item) => {
    item.classList.remove("selected");
  });
  e.target.parentElement.classList.add("selected");

  currentKids = parseInt(e.target.value);
  updateTemplate();
  updateImageSource();
}

function handleColorChange(e) {
  // Update selected style
  document.querySelectorAll(".color-variant").forEach((variant) => {
    variant.classList.remove("selected");
  });
  e.target.classList.add("selected");

  currentColor = e.target.dataset.color;
  updateImageSource();
}

function updateImageSource() {
  // Update the image source based on category, color, and kids
  baseImage.src = `${currentCategory}/${currentColor} Mug/${currentKids} Kid${
    currentKids > 1 ? "s" : ""
  } ${currentColor} Mug.jpeg`;
}

function updateTemplate() {
  clearOverlays();
  createTextControls();
  createTextOverlays();
}

function clearOverlays() {
  document.querySelectorAll(".text-overlay").forEach((overlay) => {
    overlay.remove();
  });
  textOverlays = {};
  selectedOverlay = null;
}

function createTextControls() {
  textControlsContainer.innerHTML = "";

  const template = currentTemplates[currentKids];

  template.textFields.forEach((field, index) => {
    const controlGroup = document.createElement("div");
    controlGroup.className = "text-input-group";
    controlGroup.dataset.fieldId = field.id;

    controlGroup.innerHTML = `
            <div class="form-group">
              <label>${
                field.id === "text1" ? "Dad/Mom" : `Child ${index}`
              }</label>
              <input type="text" value="${
                field.content
              }" onchange="updateFieldContent('${field.id}', this.value)">
            </div>
            
            <div class="control-group">
              <div class="control-row">
                <span class="control-label">X: ${field.xPercent}%</span>
                <div class="control-buttons">
                  <button class="control-btn" onclick="adjustField('${
                    field.id
                  }', 'xPercent', -1)">-</button>
                  <button class="control-btn" onclick="adjustField('${
                    field.id
                  }', 'xPercent', 1)">+</button>
                </div>
              </div>
              
              <div class="control-row">
                <span class="control-label">Y: ${field.yPercent}%</span>
                <div class="control-buttons">
                  <button class="control-btn" onclick="adjustField('${
                    field.id
                  }', 'yPercent', -1)">-</button>
                  <button class="control-btn" onclick="adjustField('${
                    field.id
                  }', 'yPercent', 1)">+</button>
                </div>
              </div>
              
              <div class="control-row">
                <span class="control-label">Rotation: ${field.rotation}°</span>
                <div class="control-buttons">
                  <button class="control-btn" onclick="adjustField('${
                    field.id
                  }', 'rotation', -5)">-</button>
                  <button class="control-btn" onclick="adjustField('${
                    field.id
                  }', 'rotation', 5)">+</button>
                </div>
              </div>
              
              <div class="control-row">
                <span class="control-label">Size: ${field.fontSize}px</span>
                <div class="control-buttons">
                  <button class="control-btn" onclick="adjustField('${
                    field.id
                  }', 'fontSize', -1)">-</button>
                  <button class="control-btn" onclick="adjustField('${
                    field.id
                  }', 'fontSize', 1)">+</button>
                </div>
              </div>
            </div>
          `;

    textControlsContainer.appendChild(controlGroup);
  });
}

function createTextOverlays() {
  const template = currentTemplates[currentKids];
  const imageWrapper = document.querySelector(".image-wrapper");

  template.textFields.forEach((field) => {
    const overlay = createOverlay(field);
    imageWrapper.appendChild(overlay);
    textOverlays[field.id] = overlay;
  });
}

function createOverlay(field) {
  const overlay = document.createElement("div");
  overlay.className = "text-overlay";
  overlay.dataset.fieldId = `overlay-${field.id}`;
  overlay.textContent = field.content;

  overlay.style.left = `${field.xPercent}%`;
  overlay.style.top = `${field.yPercent}%`;
  overlay.style.transform = `translate(-50%, -50%) rotate(${field.rotation}deg)`;
  overlay.style.fontSize = `${field.fontSize}px`;

  overlay.addEventListener("click", () => selectOverlay(overlay));

  return overlay;
}

function selectOverlay(overlay) {
  // Remove previous selection
  document.querySelectorAll(".text-overlay").forEach((o) => {
    o.classList.remove("selected");
  });
  document.querySelectorAll(".text-input-group").forEach((g) => {
    g.classList.remove("active");
  });

  // Select new overlay
  overlay.classList.add("selected");
  selectedOverlay = overlay;

  // Highlight corresponding control group
  const fieldId = overlay.dataset.fieldId;
  const controlGroup = document.querySelector(`[data-field-id="${fieldId}"]`);
  if (controlGroup) {
    controlGroup.classList.add("active");
  }
}

function updateFieldContent(fieldId, newContent) {
  const template = currentTemplates[currentKids];
  const field = template.textFields.find((f) => f.id === fieldId);
  if (field) {
    field.content = newContent;

    const overlay = textOverlays[fieldId];
    if (overlay) overlay.textContent = newContent;
  }
}

function adjustField(fieldId, property, delta) {
  const template = currentTemplates[currentKids];
  const field = template.textFields.find((f) => f.id === fieldId);

  if (!field) return;

  // Apply adjustment with bounds checking
  let newValue = field[property] + delta;

  // Set bounds based on property
  switch (property) {
    case "xPercent":
    case "yPercent":
      newValue = Math.max(0, Math.min(100, newValue));
      break;
    case "rotation":
      newValue = Math.max(-180, Math.min(180, newValue));
      break;
    case "fontSize":
      newValue = Math.max(8, Math.min(72, newValue));
      break;
  }

  field[property] = newValue;

  // Update overlay
  updateOverlayStyle(fieldId);

  // Update control labels
  updateControlLabels(fieldId);
}

function updateOverlayStyle(fieldId) {
  const template = currentTemplates[currentKids];
  const field = template.textFields.find((f) => f.id === fieldId);

  if (!field) return;

  const overlay = textOverlays[fieldId];

  if (overlay) {
    overlay.style.left = `${field.xPercent}%`;
    overlay.style.top = `${field.yPercent}%`;
    overlay.style.transform = `translate(-50%, -50%) rotate(${field.rotation}deg)`;
    overlay.style.fontSize = `${field.fontSize}px`;
  }
}

function updateControlLabels(fieldId) {
  const template = currentTemplates[currentKids];
  template.textFields.forEach((field) => {
    if (field.id !== fieldId) return;

    const controlGroup = document.querySelector(
      `.text-input-group[data-field-id="${field.id}"]`
    );

    if (!controlGroup) return;

    const labels = controlGroup.querySelectorAll(".control-label");

    if (labels.length >= 4) {
      labels[0].textContent = `X: ${field.xPercent}%`;
      labels[1].textContent = `Y: ${field.yPercent}%`;
      labels[2].textContent = `Rotation: ${field.rotation}°`;
      labels[3].textContent = `Size: ${field.fontSize}px`;
    }
  });
}

function adjustField(fieldId, property, delta) {
  const template = currentTemplates[currentKids];
  const field = template.textFields.find((f) => f.id === fieldId);

  if (!field) return;

  // Apply adjustment with bounds checking
  let newValue = field[property] + delta;

  // Set bounds based on property
  switch (property) {
    case "xPercent":
    case "yPercent":
      newValue = Math.max(0, Math.min(100, newValue));
      break;
    case "rotation":
      newValue = Math.max(-180, Math.min(180, newValue));
      break;
    case "fontSize":
      newValue = Math.max(8, Math.min(72, newValue));
      break;
  }

  field[property] = newValue;

  // Update overlay
  updateOverlayStyle(fieldId);

  // Update control labels - FIXED: Now properly updates the specific field's labels
  updateControlLabels(fieldId);
}

// Mouse event handlers for dragging
function handleMouseDown(e) {
  const overlay = e.target.closest(".text-overlay");
  if (!overlay) return;

  e.preventDefault();
  isDragging = true;
  selectedOverlay = overlay;

  overlay.classList.add("dragging");
  selectOverlay(overlay);

  const rect = imageContainer.getBoundingClientRect();
  dragStartPos = {
    x: e.clientX - rect.left,
    y: e.clientY - rect.top,
  };
}

function handleMouseMove(e) {
  if (!isDragging || !selectedOverlay) return;

  e.preventDefault();

  const rect = imageContainer.getBoundingClientRect();
  const imageRect = baseImage.getBoundingClientRect();

  // Calculate position relative to the image
  const x = e.clientX - imageRect.left;
  const y = e.clientY - imageRect.top;

  const xPercent = Math.max(0, Math.min(100, (x / imageRect.width) * 100));
  const yPercent = Math.max(0, Math.min(100, (y / imageRect.height) * 100));

  // Update overlay position
  selectedOverlay.style.left = `${xPercent}%`;
  selectedOverlay.style.top = `${yPercent}%`;

  // Update template data
  const fieldId = selectedOverlay.dataset.fieldId.split("-").at(1);
  const template = currentTemplates[currentKids];
  const field = template.textFields.find((f) => f.id === fieldId);

  if (field) {
    field.xPercent = Math.round(xPercent);
    field.yPercent = Math.round(yPercent);
  }
}

function handleMouseUp(e) {
  if (isDragging && selectedOverlay) {
    selectedOverlay.classList.remove("dragging");
    const fieldId = selectedOverlay.dataset.fieldId.split("-")?.at(1);
    updateControlLabels(fieldId);
  }

  isDragging = false;
  selectedOverlay = null;
  selectOverlay(null);
}

function exportTemplate() {
  const exportData = {
    category: currentCategory,
    templates: currentTemplates,
    metadata: {
      exportDate: new Date().toISOString(),
      version: "1.0",
    },
  };

  const dataStr = JSON.stringify(exportData, null, 2);
  const dataBlob = new Blob([dataStr], { type: "application/json" });

  const link = document.createElement("a");
  link.href = URL.createObjectURL(dataBlob);
  link.download = `${currentCategory}-${currentColor}-template-config-${Date.now()}.json`;
  link.click();

  URL.revokeObjectURL(link.href);
}

function importTemplate(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (event) {
    try {
      const importedData = JSON.parse(event.target.result);

      // Validate imported data structure
      if (
        importedData.templates &&
        typeof importedData.templates === "object"
      ) {
        currentTemplates = importedData.templates;
        if (importedData.category) {
          currentCategory = importedData.category;

          // Update category selector
          document.querySelectorAll(".category-variant").forEach((variant) => {
            variant.classList.remove("selected");
            if (variant.dataset.category === currentCategory) {
              variant.classList.add("selected");
            }
          });
        }

        updateImageSource();
        updateTemplate();
        alert("Template imported successfully!");
      } else {
        alert("Invalid template file format.");
      }
    } catch (error) {
      alert("Error reading template file: " + error.message);
    }
  };

  reader.readAsText(file);

  // Reset file input
  e.target.value = "";
}

// Make functions globally available
window.updateFieldContent = updateFieldContent;
window.adjustField = adjustField;

// Initialize the application when DOM is loaded
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", init);
} else {
  init();
}
