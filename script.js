// Default templates configuration for both categories
const defaultTemplates = {
  tools: {
    2: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercent: 36,
          yPercent: 53,
          rotation: 5,
          fontSize: 14,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercent: 66,
          yPercent: 44.5,
          rotation: -16,
          fontSize: 14,
        },
        {
          id: "text3",
          content: "Kelvin",
          xPercent: 66,
          yPercent: 57,
          rotation: 6,
          fontSize: 14,
        },
      ],
    },
    1: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercent: 36.5,
          yPercent: 55,
          rotation: 5,
          fontSize: 14,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercent: 67,
          yPercent: 52.5,
          rotation: -5,
          fontSize: 14,
        },
      ],
    },
    3: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercent: 36,
          yPercent: 54,
          rotation: 5,
          fontSize: 14,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercent: 64,
          yPercent: 38.5,
          rotation: -24,
          fontSize: 14,
        },
        {
          id: "text3",
          content: "Kelvin",
          xPercent: 67.7,
          yPercent: 51.5,
          rotation: -5,
          fontSize: 14,
        },
        {
          id: "text4",
          content: "Emma",
          xPercent: 62.5,
          yPercent: 66,
          rotation: 23,
          fontSize: 14,
        },
      ],
    },
    4: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercent: 36,
          yPercent: 52,
          rotation: 5,
          fontSize: 14,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercent: 59,
          yPercent: 31,
          rotation: -50,
          fontSize: 14,
        },
        {
          id: "text3",
          content: "Kelvin",
          xPercent: 68.5,
          yPercent: 43,
          rotation: -20,
          fontSize: 14,
        },
        {
          id: "text4",
          content: "Emma",
          xPercent: 68,
          yPercent: 55,
          rotation: 5,
          fontSize: 14,
        },
        {
          id: "text5",
          content: "Jake",
          xPercent: 59,
          yPercent: 67,
          rotation: 45,
          fontSize: 14,
        },
      ],
    },
    5: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercent: 36,
          yPercent: 52,
          rotation: 5,
          fontSize: 14,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercent: 48,
          yPercent: 29,
          rotation: -80,
          fontSize: 14,
        },
        {
          id: "text3",
          content: "Kelvin",
          xPercent: 63,
          yPercent: 38,
          rotation: -35,
          fontSize: 14,
        },
        {
          id: "text4",
          content: "Emma",
          xPercent: 66,
          yPercent: 50,
          rotation: -10,
          fontSize: 14,
        },
        {
          id: "text5",
          content: "Jake",
          xPercent: 62,
          yPercent: 61,
          rotation: 25,
          fontSize: 14,
        },
        {
          id: "text6",
          content: "Lily",
          xPercent: 49.5,
          yPercent: 69,
          rotation: 60,
          fontSize: 14,
        },
      ],
    },
    6: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercent: 37,
          yPercent: 52,
          rotation: 5,
          fontSize: 14,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercent: 44,
          yPercent: 30,
          rotation: -90,
          fontSize: 14,
        },
        {
          id: "text3",
          content: "Kelvin",
          xPercent: 57,
          yPercent: 31,
          rotation: -70,
          fontSize: 14,
        },
        {
          id: "text4",
          content: "Emma",
          xPercent: 67,
          yPercent: 42,
          rotation: -30,
          fontSize: 14,
        },
        {
          id: "text5",
          content: "Jake",
          xPercent: 65,
          yPercent: 56,
          rotation: 25,
          fontSize: 14,
        },
        {
          id: "text6",
          content: "Lily",
          xPercent: 56,
          yPercent: 66,
          rotation: 50,
          fontSize: 14,
        },
        {
          id: "text7",
          content: "Noah",
          xPercent: 44,
          yPercent: 70,
          rotation: 86,
          fontSize: 14,
        },
      ],
    },
  },
  soccer: {
    2: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercent: 36,
          yPercent: 53,
          rotation: 5,
          fontSize: 14,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercent: 66,
          yPercent: 44.5,
          rotation: -16,
          fontSize: 14,
        },
        {
          id: "text3",
          content: "Kelvin",
          xPercent: 66,
          yPercent: 57,
          rotation: 6,
          fontSize: 14,
        },
      ],
    },
    1: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercent: 36.5,
          yPercent: 55,
          rotation: 5,
          fontSize: 14,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercent: 67,
          yPercent: 52.5,
          rotation: -5,
          fontSize: 14,
        },
      ],
    },
    3: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercent: 36,
          yPercent: 54,
          rotation: 5,
          fontSize: 14,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercent: 64,
          yPercent: 38.5,
          rotation: -24,
          fontSize: 14,
        },
        {
          id: "text3",
          content: "Kelvin",
          xPercent: 67.7,
          yPercent: 51.5,
          rotation: -5,
          fontSize: 14,
        },
        {
          id: "text4",
          content: "Emma",
          xPercent: 62.5,
          yPercent: 66,
          rotation: 23,
          fontSize: 14,
        },
      ],
    },
    4: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercent: 36,
          yPercent: 52,
          rotation: 5,
          fontSize: 14,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercent: 59,
          yPercent: 31,
          rotation: -50,
          fontSize: 14,
        },
        {
          id: "text3",
          content: "Kelvin",
          xPercent: 68.5,
          yPercent: 43,
          rotation: -20,
          fontSize: 14,
        },
        {
          id: "text4",
          content: "Emma",
          xPercent: 68,
          yPercent: 55,
          rotation: 5,
          fontSize: 14,
        },
        {
          id: "text5",
          content: "Jake",
          xPercent: 59,
          yPercent: 67,
          rotation: 45,
          fontSize: 14,
        },
      ],
    },
    5: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercent: 36,
          yPercent: 52,
          rotation: 5,
          fontSize: 14,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercent: 48,
          yPercent: 29,
          rotation: -80,
          fontSize: 14,
        },
        {
          id: "text3",
          content: "Kelvin",
          xPercent: 63,
          yPercent: 38,
          rotation: -35,
          fontSize: 14,
        },
        {
          id: "text4",
          content: "Emma",
          xPercent: 66,
          yPercent: 50,
          rotation: -10,
          fontSize: 14,
        },
        {
          id: "text5",
          content: "Jake",
          xPercent: 62,
          yPercent: 61,
          rotation: 25,
          fontSize: 14,
        },
        {
          id: "text6",
          content: "Lily",
          xPercent: 49.5,
          yPercent: 69,
          rotation: 60,
          fontSize: 14,
        },
      ],
    },
    6: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercent: 37,
          yPercent: 52,
          rotation: 5,
          fontSize: 14,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercent: 44,
          yPercent: 30,
          rotation: -90,
          fontSize: 14,
        },
        {
          id: "text3",
          content: "Kelvin",
          xPercent: 57,
          yPercent: 31,
          rotation: -70,
          fontSize: 14,
        },
        {
          id: "text4",
          content: "Emma",
          xPercent: 67,
          yPercent: 42,
          rotation: -30,
          fontSize: 14,
        },
        {
          id: "text5",
          content: "Jake",
          xPercent: 65,
          yPercent: 56,
          rotation: 25,
          fontSize: 14,
        },
        {
          id: "text6",
          content: "Lily",
          xPercent: 56,
          yPercent: 66,
          rotation: 50,
          fontSize: 14,
        },
        {
          id: "text7",
          content: "Noah",
          xPercent: 44,
          yPercent: 70,
          rotation: 86,
          fontSize: 14,
        },
      ],
    },
  },
  printFile: {
    1: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercentLeft: 13,
          xPercentRight: 63,
          yPercent: 52,
          rotation: 5,
          fontSize: 16,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercentLeft: 39,
          xPercentRight: 89,
          yPercent: 51,
          rotation: 5,
          fontSize: 12,
        },
      ],
    },
    2: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercentLeft: 14,
          xPercentRight: 64,
          yPercent: 52,
          rotation: 5,
          fontSize: 15,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercentLeft: 39,
          xPercentRight: 89,
          yPercent: 41,
          rotation: -5,
          fontSize: 13,
        },
        {
          id: "text3",
          content: "Lucas",
          xPercentLeft: 38,
          xPercentRight: 88,
          yPercent: 59,
          rotation: 10,
          fontSize: 13,
        },
      ],
    },
    3: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercentLeft: 15,
          xPercentRight: 65,
          yPercent: 54,
          rotation: 5,
          fontSize: 15,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercentLeft: 35,
          xPercentRight: 85,
          yPercent: 30,
          rotation: -23,
          fontSize: 12,
        },
        {
          id: "text3",
          content: "Lucas",
          xPercentLeft: 38,
          xPercentRight: 88,
          yPercent: 49,
          rotation: 0,
          fontSize: 12,
        },
        {
          id: "text4",
          content: "Kelvin",
          xPercentLeft: 35,
          xPercentRight: 85,
          yPercent: 68,
          rotation: 27,
          fontSize: 12,
        },
      ],
    },
    4: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercentLeft: 12,
          xPercentRight: 65,
          yPercent: 52,
          rotation: 5,
          fontSize: 15,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercentLeft: 31,
          xPercentRight: 81,
          yPercent: 21,
          rotation: -45,
          fontSize: 13,
        },
        {
          id: "text3",
          content: "Lucas",
          xPercentLeft: 38,
          xPercentRight: 88,
          yPercent: 39,
          rotation: -15,
          fontSize: 12,
        },
        {
          id: "text4",
          content: "Kelvin",
          xPercentLeft: 38,
          xPercentRight: 88,
          yPercent: 57,
          rotation: 5,
          fontSize: 12,
        },
        {
          id: "text5",
          content: "Emma",
          xPercentLeft: 32,
          xPercentRight: 82,
          yPercent: 77,
          rotation: 45,
          fontSize: 12,
        },
      ],
    },
    5: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercentLeft: 12,
          xPercentRight: 65,
          yPercent: 52,
          rotation: 5,
          fontSize: 15,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercentLeft: 27,
          xPercentRight: 77,
          yPercent: 17,
          rotation: -75,
          fontSize: 11,
        },
        {
          id: "text3",
          content: "Lucas",
          xPercentLeft: 36,
          xPercentRight: 86,
          yPercent: 29,
          rotation: -36,
          fontSize: 11,
        },
        {
          id: "text4",
          content: "Kelvin",
          xPercentLeft: 38,
          xPercentRight: 88,
          yPercent: 49,
          rotation: 0,
          fontSize: 11,
        },
        {
          id: "text5",
          content: "Emma",
          xPercentLeft: 34,
          xPercentRight: 84,
          yPercent: 69,
          rotation: 45,
          fontSize: 11,
        },
        {
          id: "text6",
          content: "Lily",
          xPercentLeft: 26,
          xPercentRight: 76,
          yPercent: 79,
          rotation: 70,
          fontSize: 11,
        },
      ],
    },
    6: {
      textFields: [
        {
          id: "text1",
          content: "Grandpa",
          xPercentLeft: 12,
          xPercentRight: 65,
          yPercent: 53,
          rotation: 5,
          fontSize: 15,
        },
        {
          id: "text2",
          content: "Sarah",
          xPercentLeft: 23,
          xPercentRight: 73,
          yPercent: 17,
          rotation: -90,
          fontSize: 11,
        },
        {
          id: "text3",
          content: "Lucas",
          xPercentLeft: 32,
          xPercentRight: 82,
          yPercent: 23,
          rotation: -60,
          fontSize: 11,
        },
        {
          id: "text4",
          content: "Kelvin",
          xPercentLeft: 38,
          xPercentRight: 88,
          yPercent: 40,
          rotation: -24,
          fontSize: 11,
        },
        {
          id: "text5",
          content: "Emma",
          xPercentLeft: 37,
          xPercentRight: 87,
          yPercent: 59,
          rotation: 20,
          fontSize: 11,
        },
        {
          id: "text6",
          content: "Lily",
          xPercentLeft: 32,
          xPercentRight: 82,
          yPercent: 74,
          rotation: 58,
          fontSize: 11,
        },
        {
          id: "text7",
          content: "Jake",
          xPercentLeft: 22,
          xPercentRight: 72,
          yPercent: 78,
          rotation: 95,
          fontSize: 11,
        },
      ],
    },
  },
};

// Current state
let originalFieldValues = {};
let currentCategory = "soccer";
let currentKids = 1;
let currentColor = "Black";
let currentTemplates = JSON.parse(
  JSON.stringify(defaultTemplates[currentCategory])
);
let textOverlays = {};
let selectedOverlay = null;
let isDragging = false;
let dragStartPos = { x: 0, y: 0 };

const deltaX = 50;

// DOM elements
const baseImage = document.getElementById("baseImage");
const skeleton = document.getElementById("imageSkeleton");
const imageContainer = document.getElementById("imageContainer");
const textControlsContainer = document.getElementById("text-controls");
const exportBtn = document.getElementById("exportBtn");

// Initialize the application
function init() {
  setupEventListeners();
  updateImageSource();
  updateTemplate();
}

function setupEventListeners() {
  // Category selection
  document.querySelectorAll(".category-variant").forEach((variant) => {
    variant.addEventListener("click", handleCategoryChange);
  });

  // Kids selection
  document.querySelectorAll('input[name="kids"]').forEach((radio) => {
    radio.addEventListener("change", handleKidsChange);
  });

  // Color variants
  document.querySelectorAll(".color-variant").forEach((variant) => {
    variant.addEventListener("click", handleColorChange);
  });

  // Export
  exportBtn.addEventListener("click", exportTemplate);

  // Image container mouse events for dragging
  imageContainer.addEventListener("mousedown", handleMouseDown);
  document.addEventListener("mousemove", handleMouseMove);
  document.addEventListener("mouseup", handleMouseUp);
}

function storeOriginalValues() {
  const template = currentTemplates[currentKids];
  originalFieldValues[currentKids] = {};

  template.textFields.forEach((field) => {
    originalFieldValues[currentKids][field.id] = {
      xPercent: field.xPercent,
      yPercent: field.yPercent,
      rotation: field.rotation,
      fontSize: field.fontSize,
      ...(currentCategory === "printFile" && {
        xPercentLeft: field.xPercentLeft,
        xPercentRight: field.xPercentRight,
      }),
    };
  });
}

function handleCategoryChange(e) {
  // Update selected style
  const colorVariant = document.querySelector(".color-variants");
  document.querySelectorAll(".category-variant").forEach((variant) => {
    variant.classList.remove("selected");
  });
  e.target.classList.add("selected");

  currentCategory = e.target.dataset.category;
  currentTemplates = JSON.parse(
    JSON.stringify(defaultTemplates[currentCategory])
  );
  if (currentCategory === "printFile") {
    colorVariant.style.display = "none";
  } else {
    colorVariant.style.display = "flex";
  }
  updateImageSource();
  updateTemplate();
}

function handleKidsChange(e) {
  // Update selected style
  document.querySelectorAll(".kids-options .option-item").forEach((item) => {
    item.classList.remove("selected");
  });
  e.target.parentElement.classList.add("selected");

  currentKids = parseInt(e.target.value);
  updateImageSource();
}

function handleColorChange(e) {
  // Update selected style
  document.querySelectorAll(".color-variant").forEach((variant) => {
    variant.classList.remove("selected");
  });
  e.target.classList.add("selected");

  currentColor = e.target.dataset.color;
  updateImageSource();
}

function updateImageSource() {
  clearOverlays();

  baseImage.style.display = "none";

  // Show loader and hide image
  skeleton.style.display = "block";

  // Construct new image URL
  let imageUrl;
  if (currentCategory === "printFile") {
    imageUrl = `printFile/${currentKids}.png`; // Single PNG for printFile
  } else {
    imageUrl = `${currentCategory}/${currentColor} Mug/${currentKids} Kid${
      currentKids > 1 ? "s" : ""
    } ${currentColor} Mug.jpeg`;
  }

  // Set image source
  baseImage.src = imageUrl;

  // Wait for it to fully load
  baseImage.onload = function () {
    // Hide loader and show image
    skeleton.style.display = "none";
    baseImage.style.display = "block";

    updateTemplate();
  };
}

function updateTemplate() {
  clearOverlays();
  createTextControls();
  createTextOverlays();
  storeOriginalValues();
}

function clearOverlays() {
  document.querySelectorAll(".text-overlay").forEach((overlay) => {
    overlay.remove();
  });
  textOverlays = {};
  selectedOverlay = null;
}

function createTextControls() {
  textControlsContainer.innerHTML = "";

  const template = currentTemplates[currentKids];

  template.textFields.forEach((field, index) => {
    const controlGroup = document.createElement("div");
    controlGroup.className = "text-input-group";
    controlGroup.dataset.fieldId = field.id;

    const xControl =
      currentCategory === "printFile"
        ? `
        <div class="control-row">
          <span class="control-label">X Left: ${field.xPercentLeft}%</span>
          <div class="control-buttons">
            <button class="control-btn" onclick="adjustField('${field.id}', 'xPercentLeft', -0.5)">-</button>
            <button class="control-btn" onclick="adjustField('${field.id}', 'xPercentLeft', 0.5)">+</button>
          </div>
        </div>
        <div class="control-row">
          <span class="control-label">X Right: ${field.xPercentRight}%</span>
          <div class="control-buttons">
            <button class="control-btn" onclick="adjustField('${field.id}', 'xPercentRight', -0.5)">-</button>
            <button class="control-btn" onclick="adjustField('${field.id}', 'xPercentRight', 0.5)">+</button>
          </div>
        </div>
      `
        : `
        <div class="control-row">
          <span class="control-label">X: ${field.xPercent}%</span>
          <div class="control-buttons">
            <button class="control-btn" onclick="adjustField('${field.id}', 'xPercent', -0.5)">-</button>
            <button class="control-btn" onclick="adjustField('${field.id}', 'xPercent', 0.5)">+</button>
          </div>
        </div>
      `;

    controlGroup.innerHTML = `
      <div class="form-group">
        <label>${field.id === "text1" ? "Dad/Mom" : `Child ${index}`}</label>
        <input type="text" value="${
          field.content || ""
        }" onchange="updateFieldContent('${field.id}', this.value)">
      </div>
      <div class="control-group">
        ${xControl}
        <div class="control-row">
          <span class="control-label">Y: ${field.yPercent}%</span>
          <div class="control-buttons">
            <button class="control-btn" onclick="adjustField('${
              field.id
            }', 'yPercent', -0.5)">-</button>
            <button class="control-btn" onclick="adjustField('${
              field.id
            }', 'yPercent', 0.5)">+</button>
          </div>
        </div>
        <div class="control-row">
          <span class="control-label">Rotation: ${field.rotation}°</span>
          <div class="control-buttons">
            <button class="control-btn" onclick="adjustField('${
              field.id
            }', 'rotation', -1)">-</button>
            <button class="control-btn" onclick="adjustField('${
              field.id
            }', 'rotation', 1)">+</button>
          </div>
        </div>
        <div class="control-row">
          <span class="control-label">Size: ${field.fontSize}px</span>
          <div class="control-buttons">
            <button class="control-btn" onclick="adjustField('${
              field.id
            }', 'fontSize', -1)">-</button>
            <button class="control-btn" onclick="adjustField('${
              field.id
            }', 'fontSize', 1)">+</button>
          </div>
        </div>
      </div>
    `;

    textControlsContainer.appendChild(controlGroup);
  });
}

function createTextOverlays() {
  const template = currentTemplates[currentKids];
  const imageWrapper = document.querySelector(".image-wrapper");

  template.textFields.forEach((field) => {
    if (currentCategory === "printFile") {
      // Create two overlays for printFile: one for xPercentLeft, one for xPercentRight
      const leftOverlay = createOverlay(field, true);
      const rightOverlay = createOverlay(field, false);
      imageWrapper.appendChild(leftOverlay);
      imageWrapper.appendChild(rightOverlay);
      textOverlays[`${field.id}-left`] = leftOverlay;
      textOverlays[`${field.id}-right`] = rightOverlay;
    } else {
      // Single overlay for other categories
      const overlay = createOverlay(field);
      imageWrapper.appendChild(overlay);
      textOverlays[field.id] = overlay;
    }
  });
}

function createOverlay(field, isLeft) {
  const overlay = document.createElement("div");
  overlay.className = "text-overlay";
  overlay.dataset.fieldId = `overlay-${field.id}${
    currentCategory === "printFile" ? (isLeft ? "-left" : "-right") : ""
  }`;
  overlay.textContent = field.content || "";

  overlay.style.left =
    currentCategory === "printFile"
      ? isLeft
        ? `${field.xPercentLeft}%`
        : `${field.xPercentRight}%`
      : `${field.xPercent}%`;
  overlay.style.top = `${field.yPercent}%`;
  overlay.style.transform = `translate(-50%, -50%) rotate(${field.rotation}deg)`;
  overlay.style.fontSize = `${field.fontSize}px`;

  overlay.addEventListener("click", () => selectOverlay(overlay));

  return overlay;
}

function selectOverlay(overlay) {
  // Remove previous selection
  document.querySelectorAll(".text-overlay").forEach((o) => {
    o.classList.remove("selected");
  });
  document.querySelectorAll(".text-input-group").forEach((g) => {
    g.classList.remove("active");
  });

  // Select new overlay only if overlay is not null
  if (overlay) {
    const fieldId = overlay.dataset.fieldId.split("-")[1]; // Get base fieldId (e.g., text1)
    if (currentCategory === "printFile") {
      // Select both left and right overlays for the same field
      const leftOverlay = textOverlays[`${fieldId}-left`];
      const rightOverlay = textOverlays[`${fieldId}-right`];
      if (leftOverlay) leftOverlay.classList.add("selected");
      if (rightOverlay) rightOverlay.classList.add("selected");
    } else {
      overlay.classList.add("selected");
    }
    selectedOverlay = overlay;

    // Highlight corresponding control group
    const controlGroup = document.querySelector(
      `[data-field-id="overlay-${fieldId}"]`
    );
    if (controlGroup) {
      controlGroup.classList.add("active");
    }
  } else {
    selectedOverlay = null;
  }
}

function updateFieldContent(fieldId, newContent) {
  const template = currentTemplates[currentKids];
  const field = template.textFields.find((f) => f.id === fieldId);
  if (field) {
    field.content = newContent;

    if (currentCategory === "printFile") {
      const leftOverlay = textOverlays[`${fieldId}-left`];
      const rightOverlay = textOverlays[`${fieldId}-right`];
      if (leftOverlay) leftOverlay.textContent = newContent;
      if (rightOverlay) rightOverlay.textContent = newContent;
    } else {
      const overlay = textOverlays[fieldId];
      if (overlay) overlay.textContent = newContent;
    }
  }
}

function adjustField(fieldId, property, delta) {
  const template = currentTemplates[currentKids];
  const field = template.textFields.find((f) => f.id === fieldId);

  if (!field) return;

  // Get original values
  const originalValues = originalFieldValues[currentKids]?.[fieldId];
  if (!originalValues) return;

  // Apply adjustment
  let newValue = field[property] + delta;

  // Set bounds based on property with limits from original values
  switch (property) {
    case "xPercent":
      const originalPos = originalValues.xPercent;
      const minPos = Math.max(0, originalPos - 15);
      const maxPos = Math.min(100, originalPos + 15);
      newValue = Math.max(minPos, Math.min(maxPos, newValue));
      break;
    case "xPercentLeft":
    case "xPercentRight":
      const originalX = originalValues[property];
      const minX = Math.max(0, originalX - 15);
      const maxX = Math.min(100, originalX + 15);
      newValue = Math.max(minX, Math.min(maxX, newValue));
      break;
    case "yPercent":
      const originalY = originalValues.yPercent;
      const minY = Math.max(0, originalY - 15);
      const maxY = Math.min(100, originalY + 15);
      newValue = Math.max(minY, Math.min(maxY, newValue));
      break;
    case "rotation":
      const originalRot = originalValues.rotation;
      const minRot = originalRot - 50;
      const maxRot = originalRot + 50;
      newValue = Math.max(minRot, Math.min(maxRot, newValue));
      break;
    case "fontSize":
      const originalSize = originalValues.fontSize;
      const minSize = Math.max(8, originalSize - 5);
      const maxSize = Math.min(72, originalSize + 5);
      newValue = Math.max(minSize, Math.min(maxSize, newValue));
      break;
  }

  field[property] = newValue;

  // Update overlay
  updateOverlayStyle(fieldId);

  // Update control labels
  updateControlLabels(fieldId);
}

function updateOverlayStyle(fieldId) {
  const template = currentTemplates[currentKids];
  const field = template.textFields.find((f) => f.id === fieldId);

  if (!field) return;

  if (currentCategory === "printFile") {
    const leftOverlay = textOverlays[`${fieldId}-left`];
    const rightOverlay = textOverlays[`${fieldId}-right`];
    if (leftOverlay) {
      leftOverlay.style.left = `${field.xPercentLeft}%`;
      leftOverlay.style.top = `${field.yPercent}%`;
      leftOverlay.style.transform = `translate(-50%, -50%) rotate(${field.rotation}deg)`;
      leftOverlay.style.fontSize = `${field.fontSize}px`;
    }
    if (rightOverlay) {
      rightOverlay.style.left = `${field.xPercentRight}%`;
      rightOverlay.style.top = `${field.yPercent}%`;
      rightOverlay.style.transform = `translate(-50%, -50%) rotate(${field.rotation}deg)`;
      rightOverlay.style.fontSize = `${field.fontSize}px`;
    }
  } else {
    const overlay = textOverlays[fieldId];
    if (overlay) {
      overlay.style.left = `${field.xPercent}%`;
      overlay.style.top = `${field.yPercent}%`;
      overlay.style.transform = `translate(-50%, -50%) rotate(${field.rotation}deg)`;
      overlay.style.fontSize = `${field.fontSize}px`;
    }
  }
}

function updateControlLabels(fieldId) {
  const template = currentTemplates[currentKids];
  template.textFields.forEach((field) => {
    if (field.id !== fieldId) return;

    const controlGroup = document.querySelector(
      `.text-input-group[data-field-id="${field.id}"]`
    );

    if (!controlGroup) return;

    const labels = controlGroup.querySelectorAll(".control-label");

    if (labels.length >= 4) {
      if (currentCategory === "printFile") {
        labels[0].textContent = `X Left: ${field.xPercentLeft}%`;
        labels[1].textContent = `X Right: ${field.xPercentRight}%`;
        labels[2].textContent = `Y: ${field.yPercent}%`;
        labels[3].textContent = `Rotation: ${field.rotation}°`;
        labels[4].textContent = `Size: ${field.fontSize}px`;
      } else {
        labels[0].textContent = `X: ${field.xPercent}%`;
        labels[1].textContent = `Y: ${field.yPercent}%`;
        labels[2].textContent = `Rotation: ${field.rotation}°`;
        labels[3].textContent = `Size: ${field.fontSize}px`;
      }
    }
  });
}

// Mouse event handlers for dragging
function handleMouseDown(e) {
  const overlay = e.target.closest(".text-overlay");
  if (!overlay) return;

  e.preventDefault();
  isDragging = true;
  selectedOverlay = overlay;

  overlay.classList.add("dragging");
  selectOverlay(overlay);

  if (currentCategory === "printFile") {
  }

  const rect = imageContainer.getBoundingClientRect();
  dragStartPos = {
    x: e.clientX - rect.left,
    y: e.clientY - rect.top,
  };
}

function handleMouseMove(e) {
  if (!isDragging || !selectedOverlay) return;

  e.preventDefault();

  const rect = imageContainer.getBoundingClientRect();
  const imageRect = baseImage.getBoundingClientRect();

  // Calculate position relative to the image
  const x = e.clientX - imageRect.left;
  const y = e.clientY - imageRect.top;

  let xPercent = Math.max(0, Math.min(100, (x / imageRect.width) * 100));
  let yPercent = Math.max(0, Math.min(100, (y / imageRect.height) * 100));

  // Get field ID and original values
  const fieldId = selectedOverlay.dataset.fieldId.split("-")[1];
  const originalValues = originalFieldValues[currentKids]?.[fieldId];
  const template = currentTemplates[currentKids];
  const field = template.textFields.find((f) => f.id === fieldId);

  if (originalValues) {
    if (currentCategory === "printFile") {
      // Apply position bounds (+/-15% from original for xPercentLeft and xPercentRight)
      const minXLeft = Math.max(0, originalValues.xPercentLeft - 15);
      const maxXLeft = Math.min(100, originalValues.xPercentLeft + 15);
      const minXRight = Math.max(0, originalValues.xPercentRight - 15);
      const maxXRight = Math.min(100, originalValues.xPercentRight + 15);
      const minY = Math.max(0, originalValues.yPercent - 15);
      const maxY = Math.min(100, originalValues.yPercent + 15);

      if (selectedOverlay.dataset.fieldId.includes("-left")) {
        xPercent = Math.max(minXLeft, Math.min(maxXLeft, xPercent));
      } else {
        xPercent = Math.max(minXRight, Math.min(maxXRight, xPercent));
      }
      yPercent = Math.max(minY, Math.min(maxY, yPercent));
    } else {
      // Apply position bounds (+/-15% from original)
      const minX = Math.max(0, originalValues.xPercent - 15);
      const maxX = Math.min(100, originalValues.xPercent + 15);
      const minY = Math.max(0, originalValues.yPercent - 15);
      const maxY = Math.min(100, originalValues.yPercent + 15);

      xPercent = Math.max(minX, Math.min(maxX, xPercent));
      yPercent = Math.max(minY, Math.min(maxY, yPercent));
    }
  }

  // Update overlay position
  if (currentCategory === "printFile") {
    const isLeftOverlay = selectedOverlay.dataset.fieldId.includes("-left");
    const leftOverlay = textOverlays[`${fieldId}-left`];
    const rightOverlay = textOverlays[`${fieldId}-right`];

    if (leftOverlay) {
      leftOverlay.style.left = isLeftOverlay
        ? `${xPercent}%`
        : `${field.xPercentLeft}%`;
      leftOverlay.style.top = `${yPercent}%`;
    }
    if (rightOverlay) {
      rightOverlay.style.left = isLeftOverlay
        ? `${xPercent + deltaX}%`
        : `${xPercent}%`;
      rightOverlay.style.top = `${yPercent}%`;
    }
  } else {
    selectedOverlay.style.left = `${xPercent}%`;
    selectedOverlay.style.top = `${yPercent}%`;
  }

  // Update template data
  if (field) {
    if (currentCategory === "printFile") {
      if (selectedOverlay.dataset.fieldId.includes("-left")) {
        field.xPercentLeft = Math.round(xPercent);
        field.xPercentRight = Math.round(xPercent + deltaX);
      } else {
        field.xPercentRight = Math.round(xPercent);
        field.xPercentLeft = Math.round(xPercent - deltaX);
      }
      field.yPercent = Math.round(yPercent);
    } else {
      field.xPercent = Math.round(xPercent);
      field.yPercent = Math.round(yPercent);
    }
  }
}

function handleMouseUp(e) {
  if (isDragging && selectedOverlay) {
    selectedOverlay.classList.remove("dragging");
    const fieldId = selectedOverlay.dataset.fieldId.split("-")[1];
    updateControlLabels(fieldId);
  }

  isDragging = false;
  selectedOverlay = null;
  selectOverlay(null);
}

function exportTemplate() {
  const exportData = {
    category: currentCategory,
    templates: currentTemplates,
    color: currentCategory !== "printFile" ? currentColor : null,
    metadata: {
      exportDate: new Date().toISOString(),
      version: "1.0",
      publisher: "10daer",
    },
  };

  const dataStr = JSON.stringify(exportData, null, 2);
  const dataBlob = new Blob([dataStr], { type: "application/json" });

  const link = document.createElement("a");
  link.href = URL.createObjectURL(dataBlob);
  link.download =
    currentCategory !== "printFile"
      ? `${currentCategory}-${currentColor}-template-config-${Date.now()}.json`
      : `${currentCategory}-template-config-${Date.now()}.json`;
  link.click();

  URL.revokeObjectURL(link.href);
}

// Make functions globally available
window.updateFieldContent = updateFieldContent;
window.adjustField = adjustField;

// Initialize the application when DOM is loaded
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", init);
} else {
  init();
}
